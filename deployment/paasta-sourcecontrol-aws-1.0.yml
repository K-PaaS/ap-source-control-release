---
name: paasta-sourcecontrol                               # 서비스 배포이름(필수) bosh deployments 로 확인가능한 이름
director_uuid: <%= `bosh status --uuid` %>     # Director UUID을 입력(필수) bosh status 명령으로 확인가능
releases:
- name: paasta-sourcecontrol-release
  version: 1.0

compilation:                                            # 컴파일시 필요한 가상머신의 속성(필수)
  workers: 6          # 컴파일 하는 가상머신의 최대수(필수)
  network: default    # Networks block에서 선언한 network 이름(필수)
  reuse_compilation_vms: true
  cloud_properties:   # 컴파일 VM을 만드는 데 필요한 IaaS의 특정 속성 (instance_type, availability_zone), 직접 cpu,disk,ram 사이즈를 넣어도 됨
    availability_zone: ap-northeast-2c
    instance_type: c4.large
# this section describes how updates are handled
update:
  canaries: 1                                    # canary 인스턴스 수(필수)
  canary_watch_time: 5000-120000                    # canary 인스턴스가 수행하기 위한 대기 시간(필수)
  update_watch_time: 5000-120000                    # non-canary 인스턴스가 수행하기 위한 대기 시간(필수)
  max_in_flight: 1                              # non-canary 인스턴스가 병렬로 update 하는 최대 개수(필수)
  serial: false

networks:
- name: default               # 네트워크 블록에 나열된 각 서브 블록이 참조 할 수있는 작업이 네트워크 구성을 지정, 네트워크 구성은 네트워크 담당자에게 문의 하여 작성 요망
  type: manual
  subnets:
  - range: 10.0.0.0/24
    gateway: 10.0.0.1
    dns: [10.0.0.2, 8.8.8.8]                      # DNS 정보
    reserved: ["10.0.0.1 - 10.0.0.139","10.0.0.150 - 10.0.0.201"]            # 설치시 제외할 IP 설정
    static: ["10.0.0.140 - 10.0.0.149"]
    cloud_properties:
      subnet: subnet-dcf6db91                     # AWS subnet id
      security_groups:
        - default
        - handy-wot-paas-sg

- name: op_public_network
  type: vip
  cloud_properties: {}

resource_pools:               # 배포시 사용하는 resource pools를 명시하며 여러 개의 resource pools 을 사용할 경우 name 은 unique 해야함(필수)
  - name: first_pools      # 고유한 resource pool 이름
    network: default
    stemcell:
      name: bosh-aws-xen-hvm-ubuntu-trusty-go_agent  # stemcell 이름(필수)
      version: 3445.2           # stemcell 버전(필수)
    cloud_properties:         # 컴파일 VM을 만드는 데 필요한 IaaS의 특정 속성을 설명 (instance_type, availability_zone), 직접 cpu, disk, 메모리 설정가능
      instance_type: t2.micro
      availability_zone: ap-northeast-2c
    env:
      bosh:       #password : c1oudc0w
        password: $6$4gDD3aV0rdqlrKC$2axHCxGKIObs6tAmMTqYCspcdvQXh3JJcvWOY2WGb4SrdXtnCyNaWlrf3WEqvYR2MYizEGp3kMmbpwBC6jsHt0

  - name: second_pools      # 고유한 resource pool 이름
    network: default
    stemcell:
      name: bosh-aws-xen-hvm-ubuntu-trusty-go_agent  # stemcell 이름(필수)
      version: 3445.2           # stemcell 버전(필수)
    cloud_properties:         # 컴파일 VM을 만드는 데 필요한 IaaS의 특정 속성을 설명 (instance_type, availability_zone), 직접 cpu, disk, 메모리 설정가능
      instance_type: t2.micro
      availability_zone: ap-northeast-2c
    env:
      bosh:       #password : c1oudc0w
        password: $6$4gDD3aV0rdqlrKC$2axHCxGKIObs6tAmMTqYCspcdvQXh3JJcvWOY2WGb4SrdXtnCyNaWlrf3WEqvYR2MYizEGp3kMmbpwBC6jsHt0

  - name: third_pools      # 고유한 resource pool 이름
    network: default
    stemcell:
      name: bosh-aws-xen-hvm-ubuntu-trusty-go_agent  # stemcell 이름(필수)
      version: 3445.2           # stemcell 버전(필수)
    cloud_properties:         # 컴파일 VM을 만드는 데 필요한 IaaS의 특정 속성을 설명 (instance_type, availability_zone), 직접 cpu, disk, 메모리 설정가능
      instance_type: t2.micro
      availability_zone: ap-northeast-2c
    env:
      bosh:       #password : c1oudc0w
        password: $6$4gDD3aV0rdqlrKC$2axHCxGKIObs6tAmMTqYCspcdvQXh3JJcvWOY2WGb4SrdXtnCyNaWlrf3WEqvYR2MYizEGp3kMmbpwBC6jsHt0

  - name: four_pools      # 고유한 resource pool 이름
    network: default
    stemcell:
      name: bosh-aws-xen-hvm-ubuntu-trusty-go_agent  # stemcell 이름(필수)
      version: 3445.2           # stemcell 버전(필수)
    cloud_properties:       # 컴파일 VM을 만드는 데 필요한 IaaS의 특정 속성을 설명 (instance_type, availability_zone), 직접 cpu, disk, 메모리 설정가능
      instance_type: t2.small
      availability_zone: ap-northeast-2c
    env:
      bosh:       #password : c1oudc0w
        password: $6$4gDD3aV0rdqlrKC$2axHCxGKIObs6tAmMTqYCspcdvQXh3JJcvWOY2WGb4SrdXtnCyNaWlrf3WEqvYR2MYizEGp3kMmbpwBC6jsHt0

jobs:
- name: scm-server
  instances: 1
  resource_pool: four_pools          # resource_pools block에 정의한 resource pool 이름(필수)
  persistent_disk: 30720                 # 영구적 디스크 사이즈 정의(옵션)
  networks:                              # 네트워크 구성정보
  - name: default                        # Networks block에서 선언한 network 이름(필수) 내부 네트워크 설정
    static_ips:
    - 10.0.0.141                      # 사용할 내부 IP addresses 정의(필수)
  templates:
  - name: scm-server
    release: paasta-sourcecontrol-release
  update:
    max_in_flight: 1
    serial: true

- name: mariadb                   
  instances: 1                    # job ÀÎ½ºÅÏ½º ¼ö(ÇÊ¼ö)
  resource_pool: third_pools      # resource_pools block¿¡ Á¤ÀÇÇÑ resource pool ÀÌ¸§(ÇÊ¼ö)
  persistent_disk: 2048
  networks:
  - name: default                 # Networks block
    static_ips:
    - 10.0.0.142
  templates:
  - name: mariadb
    release: paasta-sourcecontrol-release
  update:
    max_in_flight: 1
    serial: true

- name: haproxy
  instances: 1
  resource_pool: first_pools           # resource_pools block
  persistent_disk: 2048
  networks:
  - default:
    - gateway
    - dns
    name: default
    static_ips:
    - 10.0.0.143
  - name: op_public_network
    static_ips:
    - 13.125.82.163                                   #public ip change it!
  templates:
  - name: haproxy
    release: paasta-sourcecontrol-release
  update:
    max_in_flight: 1
    serial: true

- name: sourcecontrol-webui
  instances: 1
  resource_pool: second_pools
  persistent_disk: 2048
  networks:
  - name: default
    static_ips:
    - 10.0.0.144
    serial: true
  templates:
  - name: sourcecontrol-webui
    release: paasta-sourcecontrol-release
  update:
    max_in_flight: 1
    serial: true

- name: sourcecontrol-api
  instances: 1
  resource_pool: second_pools
  persistent_disk: 2048
  networks:
  - name: default
    static_ips:
    - 10.0.0.145
  templates:
  - name: sourcecontrol-api
    release: paasta-sourcecontrol-release
  update:
    max_in_flight: 1
    serial: true

- name: sourcecontrol-broker
  instances: 1
  resource_pool: second_pools
  persistent_disk: 2048
  networks:
  - name: default
    static_ips:
    - 10.0.0.146
  templates:
  - name: sourcecontrol-broker
    release: paasta-sourcecontrol-release
  update:
    max_in_flight: 1
    serial: true

properties:
  spring:
    datasource:
      url: jdbc:mysql://10.0.0.142:31306/PAASTA_SRC_DB?autoReconnect=true&useUnicode=true&characterEncoding=utf8
      username: sourcecontrol
      password: "!scadmin2017"
      databasename: "PAASTA_SRC_DB"
    jpa:
      database: mysql

  haproxy:                                # sourcecontrol haproxy
    host_ip: 10.0.0.143                # sourcecontrol haproxy host IP
    url: 10.0.0.143                # sourcecontrol haproxy host IP
    http_port: 8080                         # sourcecontrol haproxy host port

  sourcecontrol-webui:                  # sourcecontrol webui
    port: 8081
    haproxy:
      urls:
      - 10.0.0.144
    java_opts: '-XX:MaxMetaspaceSize=104857K -Xss349K -Xms681574K -XX:MetaspaceSize=104857K -Xmx681574K'

  sourcecontrol-api:                    # sourcecontrol api
    haproxy:
      urls:
        - 10.0.0.145
    base:
      url: http://10.0.0.145:8082        # sourcecontrol api base url
    port: 8082                              # sourcecontrol api port
    java_opts: '-XX:MaxMetaspaceSize=104857K -Xss349K -Xms681574K -XX:MetaspaceSize=104857K -Xmx681574K'

  sourcecontrol-broker:                 # sourcecontrol broker
    port: 8080                               # sourcecontrol port
    java_opts: '-XX:MaxMetaspaceSize=104857K -Xss349K -Xms681574K -XX:MetaspaceSize=104857K -Xmx681574K'

  mariadb:
    port: 31306
    datasource:
      username: root
      password: "!paas_ta202"
      databasename: "PAASTA_SRC_DB"

  scm:
    haproxy:
      urls:
        - 10.0.0.141
    base:
      url: http://10.0.0.141:8083/scm
      port: 8083
    clone:
      url: http://13.125.82.163:8083/scm

  dashboard:
    url: http://13.125.82.163:8081/repositories/user/{instanceId}

  api:
    user: '/api/rest/users'
    repo: '/api/rest/repositories'

  cf:
    uaa:
      oauth:
        info:
          uri: https://uaa.wot.paasta-dev.com/userinfo
        token:
          check:
            uri: https://uaa.wot.paasta-dev.com/check_token
          access:
            uri: https://uaa.wot.paasta-dev.com/oauth/token
        logout:
          url: https://uaa.wot.paasta-dev.com/logout.do
        authorization:
          uri: https://uaa.wot.paasta-dev.com/oauth/authorize
        client:
          id: scclient
          secret: clientsecret
    api:
      url: https://api.wot.paasta-dev.com/v2/service_instances/[SUID]/permissions
